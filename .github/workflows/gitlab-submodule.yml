name: Software Publication Direct

on:
  push:
    branches:
      - main

jobs:
  hermes-deposit:
    name: Harvest â†’ Process â†’ Curate â†’ Deposit
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - run: |
          echo "::notice::ðŸ“¦ Installing HERMES..."
          pip install hermes
          echo "::notice::âœ… HERMES installed"

      - run: |
          echo "ðŸš€ Starting HERMES harvest..."
          hermes harvest
          echo "âœ… Harvest complete"

      - run: |
          echo "ðŸ›  Processing metadata..."
          hermes process
          echo "âœ… Process complete"

      - run: |
          echo "ðŸ“ Curating metadata..."
          hermes curate
          echo "âœ… Curation complete"

      - run: |
          echo "ðŸ” Running basic checks..."
          if [ ! -f CITATION.cff ]; then
            echo "âŒ CITATION.cff missing, stopping workflow"
            exit 1
          fi
          echo "âœ… All required files present"

      - run: |
          echo "ðŸ“¦ Archiving repository files..."
          git archive --format zip HEAD > artifact.zip
          echo "âœ… Archive created: artifact.zip"

      - run: |
          echo "ðŸ“¤ Depositing to Zenodo Sandbox..."
          hermes deposit --initial -O invenio_rdm.auth_token ${{ secrets.ZENODO_SANDBOX }} --file artifact.zip --file README.md
          echo "âœ… Deposit complete"
